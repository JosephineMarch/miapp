<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Crea Infantil - Centro Creativo</title>
    <meta name="description" content="App de productividad para ilustradoras y escritoras de libros infantiles. Gestiona tareas, ideas y tu energ√≠a creativa.">
    <meta name="theme-color" content="#1D9A8D">
    <link rel="manifest" href="data:application/json;base64,eyJuYW1lIjoiQ3JlYSBJbmZhbnRpbCIsImRpc3BsYXkiOiJzdGFuZGFsb25lIiwiYmFja2dyb3VuZF9jb2xvciI6IiNGRkZGRkYiLCJ0aGVtZV9jb2xvciI6IiMxRDlBOEQifQ==">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns"></script>
    <style>
        :root {
            --bg-color: #f8f9fa; --card-bg: #ffffff; --text-color: #212529;
            --primary-color: #1D9A8D; --primary-light: #e8f5f4; --secondary-color: #f4a261;
            --danger-color: #e76f51; --success-color: #2a9d8f; --border-color: #dee2e6;
            --shadow: 0 4px 12px rgba(0, 0, 0, 0.08); --border-radius: 12px;
        }
        .dark-mode {
            --bg-color: #121212; --card-bg: #1e1e1e; --text-color: #e0e0e0;
            --primary-light: #2c3e50; --border-color: #444;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color); color: var(--text-color);
            transition: background-color 0.3s, color 0.3s; min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 15px; }
        #login-container { display: flex; flex-direction: column; justify-content: center; align-items: center; height: 80vh; text-align: center; }
        #app-container { display: none; }
        .header { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; margin-bottom: 20px; }
        .header-left { display: flex; align-items: center; gap: 15px; }
        .header h1 { font-size: 24px; color: var(--primary-color); }
        .focus-streak { font-size: 14px; background-color: var(--primary-light); color: var(--primary-color); padding: 5px 10px; border-radius: 20px; font-weight: 500;}
        .user-info { display: flex; align-items: center; gap: 10px; }
        .user-info span { font-size: 14px; }
        .theme-toggle { background: none; border: 1px solid var(--border-color); width: 40px; height: 40px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; }
        .nav-tabs { display: flex; overflow-x: auto; border-bottom: 1px solid var(--border-color); margin-bottom: 20px; -ms-overflow-style: none; scrollbar-width: none; }
        .nav-tabs::-webkit-scrollbar { display: none; }
        .nav-tab { display: flex; align-items: center; gap: 8px; padding: 12px 16px; background: none; border: none; color: var(--text-color); opacity: 0.7; font-size: 14px; font-weight: 500; cursor: pointer; transition: all 0.2s ease; border-bottom: 2px solid transparent; white-space: nowrap; }
        .nav-tab:hover { opacity: 1; background-color: var(--primary-light); }
        .nav-tab.active { opacity: 1; color: var(--primary-color); border-bottom-color: var(--primary-color); }
        .tab-content { display: none; animation: fadeIn 0.4s ease; }
        .tab-content.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .card { background: var(--card-bg); border-radius: var(--border-radius); padding: 25px; margin-bottom: 20px; box-shadow: var(--shadow); border: 1px solid var(--border-color); }
        .card h3 { color: var(--primary-color); margin-bottom: 20px; font-size: 18px; }
        
        input[type="text"], input[type="number"], select, textarea { width: 100%; padding: 12px 15px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background-color: var(--bg-color); color: var(--text-color); outline: none; margin-bottom: 10px; transition: border-color .2s, box-shadow .2s; }
        input:focus, select:focus, textarea:focus { border-color: var(--primary-color); box-shadow: 0 0 0 2px var(--primary-light); }
        button { padding: 12px 20px; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 500; transition: all 0.2s ease; display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--primary-color); color: white; }
        .btn-secondary { background-color: var(--secondary-color); color: white; }
        .btn-subtle { background-color: var(--primary-light); color: var(--primary-color); border: 1px solid transparent; }
        .btn-subtle.active { background-color: var(--primary-color); color: white; }
        .btn-icon { background: none; padding: 5px; width: 32px; height: 32px; border: none; border-radius: 50%; }
        .btn-icon:hover { background-color: var(--primary-light); }
        .icon { display: inline-block; width: 1em; height: 1em; stroke-width: 0; stroke: currentColor; fill: currentColor; }
        svg { fill: currentColor; }

        .item-list { max-height: 250px; overflow-y: auto; padding-right: 5px; }
        .list-item { display: flex; align-items: center; gap: 12px; padding: 10px; border-radius: 8px; margin-bottom: 8px; transition: background-color 0.2s, opacity 0.3s; }
        .list-item:hover { background-color: var(--bg-color); }
        .list-item.completed { opacity: 0.6; }
        .list-item.completed .item-text { text-decoration: line-through; }
        .list-item input[type="checkbox"] { width: 18px; height: 18px; accent-color: var(--primary-color); cursor: pointer; flex-shrink: 0; }
        .item-text-content { flex: 1; min-width: 0; }
        .item-text { font-size: 15px; word-break: break-word; }
        .item-details { font-size: 12px; opacity: 0.7; }
        .item-actions { margin-left: auto; display:flex; gap: 5px; flex-shrink: 0; }
        .divider { border: 0; height: 1px; background-color: var(--border-color); margin: 20px 0; }
        
        #inboxList .list-item { align-items: flex-start; }
        .inbox-text { word-break: break-word; }
        .inbox-link { display: block; margin-top: 5px; color: var(--secondary-color); text-decoration: none; font-weight: 500; word-break: break-all; }
        
        .report-controls { display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; }
        .chart-container { position: relative; height: 280px; width: 100%; margin-bottom: 30px; }
        #reportSummary { margin-top: 20px; line-height: 1.6; }
        #reportSummary strong { color: var(--primary-color); }
        #reportSummary ul { padding-left: 20px; margin-top: 10px; }

        .achievements-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .achievement-card { padding: 15px; border: 1px solid var(--border-color); border-radius: 8px; text-align: center; transition: all 0.3s ease; }
        .achievement-card .icon { font-size: 40px; }
        .achievement-card p { font-size: 12px; font-weight: 500; margin-top: 5px; }
        .achievement-card.locked { opacity: 0.4; filter: grayscale(1); }
        .achievement-card.unlocked { color: var(--secondary-color); border-color: var(--secondary-color); transform: scale(1.05); }

        .notification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background: #2c3e50; color: white; padding: 15px 25px; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); z-index: 1001; transition: bottom 0.5s ease; pointer-events: none; }
        .notification.show { bottom: 20px; }
        
        #currentActivity { display: none; text-align: center; }
        #activityForm, #currentActivity { padding: 15px; background: var(--primary-light); border-radius: var(--border-radius); }
    </style>
</head>
<body>
    <svg xmlns="http://www.w3.org/2000/svg" style="display: none;">
        <symbol id="icon-tasks" viewBox="0 0 24 24"><path d="M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8l-6-6zM6 20V4h7v5h5v11H6z"/><path d="m9 17-3-3 1.41-1.41L9 14.17l4.59-4.59L15 11l-6 6z"/></symbol>
        <symbol id="icon-inbox" viewBox="0 0 24 24"><path d="M19 3H5c-1.11 0-2 .9-2 2v14c0 1.1.89 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-2 12h-4c0 1.66-1.34 3-3 3s-3-1.34-3-3H5V5h14v10z"/></symbol>
        <symbol id="icon-activities" viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2zm-1 14h2V7h-2v9zm1-11a1.5 1.5 0 1 1 0-3 1.5 1.5 0 0 1 0 3z" clip-rule="evenodd" fill-rule="evenodd"/></symbol>
        <symbol id="icon-report" viewBox="0 0 24 24"><path d="M4 9h4v11H4zm6 3h4v8h-4zm6-6h4v14h-4z"/></symbol>
        <symbol id="icon-play" viewBox="0 0 24 24"><path d="M8 5v14l11-7z"/></symbol>
        <symbol id="icon-stop" viewBox="0 0 24 24"><path d="M6 6h12v12H6z"/></symbol>
        <symbol id="icon-add" viewBox="0 0 24 24"><path d="M19 13h-6v6h-2v-6H5v-2h6V5h2v6h6v2z"/></symbol>
        <symbol id="icon-delete" viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></symbol>
        <symbol id="icon-moon" viewBox="0 0 24 24"><path d="M9.37 5.51A7.35 7.35 0 0 0 9.1 7.5c0 4.08 3.32 7.4 7.4 7.4.68 0 1.35-.09 1.99-.27C17.45 18.2 14.9 20 12 20c-4.41 0-8-3.59-8-8 0-2.91 1.8-5.45 4.37-6.49z"/></symbol>
        <symbol id="icon-sun" viewBox="0 0 24 24"><path d="M12 7c-2.76 0-5 2.24-5 5s2.24 5 5 5 5-2.24 5-5-2.24-5-5-5zM2 13h2c.03-3.63 2.94-6.54 6.57-6.57L10 4.41c-4.22.36-7.64 3.78-8 8zM20 13h2c-.36-4.22-3.78-7.64-8-8v2.02c3.63.03 6.54 2.94 6.57 6.57L20 13z"/></symbol>
        <symbol id="icon-google" viewBox="0 0 48 48"><path fill="#4285F4" d="M45.12 24.5c0-1.56-.14-3.06-.4-4.5H24v8.51h11.84c-.51 2.75-2.06 5.08-4.39 6.64v5.52h7.11c4.16-3.83 6.56-9.47 6.56-16.17z"/><path fill="#34A853" d="M24 48c6.48 0 11.93-2.13 15.89-5.8l-7.11-5.52c-2.16 1.45-4.92 2.3-8.78 2.3-6.68 0-12.35-4.48-14.38-10.48H2.1v5.7C6.02 42.66 14.48 48 24 48z"/><path fill="#FBBC05" d="M9.62 28.18c-.48-1.45-.76-3-.76-4.68s.28-3.23.76-4.68V13.1H2.1c-1.4 2.78-2.23 5.92-2.23 9.22s.84 6.44 2.23 9.22l7.52-5.72z"/><path fill="#EA4335" d="M24 9.48c3.52 0 6.62 1.22 9.09 3.52l6.29-6.29C35.91 2.82 30.46 0 24 0 14.48 0 6.02 5.34 2.1 13.1l7.52 5.72C11.65 13.96 17.32 9.48 24 9.48z"/></symbol>
        <symbol id="icon-trophy" viewBox="0 0 24 24"><path d="M19 4h-2.5l-1-2h-7l-1 2H5c-1.1 0-2 .9-2 2v13c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2zm-7 0c.55 0 1 .45 1 1s-.45 1-1 1-1-.45-1-1 .45-1 1-1zm0 15c-3.31 0-6-2.69-6-6s2.69-6 6-6 6 2.69 6 6-2.69 6-6 6z"/><path d="M12 9c-1.66 0-3 1.34-3 3s1.34 3 3 3 3-1.34 3-3-1.34-3-3-3z"/></symbol>
        <symbol id="icon-forward" viewBox="0 0 24 24"><path d="m12 8-6 6 1.41 1.41L12 10.83l4.59 4.58L18 14l-6-6z"/></symbol>
        <symbol id="icon-logout" viewBox="0 0 24 24"><path d="M17 7l-1.41 1.41L18.17 11H8v2h10.17l-2.58 2.58L17 17l5-5zM4 5h8V3H4c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h8v-2H4V5z"/></symbol>
    </svg>
    
    <div id="login-container" class="container">
        <div class="card" style="max-width: 400px; text-align: center;">
            <svg class="icon" style="font-size: 60px; color: var(--primary-color); margin-bottom: 20px;"><use href="#icon-tasks"/></svg>
            <h2>Bienvenida a tu Centro Creativo</h2>
            <p style="margin: 15px 0;">Inicia sesi√≥n para guardar y sincronizar tu progreso en todos tus dispositivos.</p>
            <button id="loginBtn" class="btn-primary" style="width: 100%;">
                <svg class="icon"><use href="#icon-google"/></svg>
                Iniciar sesi√≥n con Google
            </button>
        </div>
    </div>

    <div id="app-container" class="container">
        <header class="header">
            <div class="header-left">
                <h1>Crea Infantil</h1>
                <div id="focusStreak" class="focus-streak" title="D√≠as seguidos registrando actividad"></div>
            </div>
            <div class="user-info">
                 <span id="user-display"></span>
                 <button class="btn-icon" id="logoutBtn" title="Cerrar sesi√≥n"><svg class="icon"><use href="#icon-logout"/></svg></button>
                 <button class="theme-toggle" id="theme-toggle" title="Cambiar tema">
                    <svg class="icon"><use href="#icon-moon"/></svg>
                 </button>
            </div>
        </header>

        <nav class="nav-tabs">
            <button class="nav-tab active" data-tab="tasks"><svg class="icon"><use href="#icon-tasks"/></svg> Tareas</button>
            <button class="nav-tab" data-tab="inbox"><svg class="icon"><use href="#icon-inbox"/></svg> Bandeja de Ideas</button>
            <button class="nav-tab" data-tab="activities"><svg class="icon"><use href="#icon-activities"/></svg> Cronometrar</button>
            <button class="nav-tab" data-tab="reports"><svg class="icon"><use href="#icon-report"/></svg> Reportes y Logros</button>
        </nav>

        <div class="tab-content active" id="tasks">
             <div class="card">
                <h3>üìù Tareas Pendientes</h3>
                <div style="display:flex; gap:10px;">
                    <input type="text" id="taskInput" placeholder="Ej: Bocetar los personajes principales">
                    <button class="btn-primary" id="addTaskBtn" title="A√±adir Tarea"><svg class="icon"><use href="#icon-add"/></svg></button>
                </div>
                <div class="item-list" id="taskListPending"></div>
                <hr class="divider" id="completed-divider" style="display:none;">
                <h3 id="completed-title" style="display:none; margin-top:20px;">‚úÖ Tareas Completadas</h3>
                <div class="item-list" id="taskListCompleted"></div>
            </div>
        </div>
        <div class="tab-content" id="inbox">
            <div class="card">
                <h3>üí° Bandeja de Ideas R√°pidas</h3>
                <p class="item-details" style="margin-bottom:15px;">Captura aqu√≠ todas esas ideas, enlaces o pensamientos que se te cruzan. ¬°Libera tu mente!</p>
                <textarea id="inboxText" rows="3" placeholder="Escribe tu idea, un fragmento de texto..."></textarea>
                <input type="text" id="inboxUrl" placeholder="Pega un enlace (opcional)">
                <button class="btn-primary" id="addInboxBtn" style="width:100%"><svg class="icon"><use href="#icon-add"/></svg> Guardar Idea</button>
            </div>
            <div class="card">
                <h3>üì¶ Ideas Guardadas</h3>
                <div class="item-list" id="inboxList"></div>
            </div>
        </div>
        <div class="tab-content" id="activities">
             <div class="card">
                <h3>‚è±Ô∏è Cronometrar Actividad</h3>
                <div id="activityForm">
                    <select id="activityType">
                        <option value="üé® Ilustraci√≥n">üé® Ilustraci√≥n</option>
                        <option value="üìù Escritura">üìù Escritura</option>
                        <option value="üìê Maquetaci√≥n">üìê Maquetaci√≥n</option>
                        <option value="üí° Brainstorming">üí° Brainstorming</option>
                        <option value="üìö Investigaci√≥n">üìö Investigaci√≥n</option>
                        <option value="üì± Redes Sociales">üì± Redes Sociales</option>
                    </select>
                    <input type="text" id="activityDescription" placeholder="¬øEn qu√© est√°s trabajando espec√≠ficamente?">
                    <button class="btn-primary" id="startActivityBtn" style="width:100%;"><svg class="icon"><use href="#icon-play"/></svg> Empezar</button>
                </div>
                <div id="currentActivity">
                    <p id="currentActivityInfo" style="font-weight:500;"></p>
                    <div id="activityTimer" style="font-size: 2.5em; font-weight: 700; color: var(--primary-color); margin: 10px 0;">00:00:00</div>
                    <button class="btn-danger" id="stopActivityBtn" style="width:100%; margin-top:15px;"><svg class="icon"><use href="#icon-stop"/></svg> Detener y Registrar</button>
                </div>
            </div>
             <div class="card">
                <h3>üìã Actividades Registradas Hoy</h3>
                <div class="item-list" id="activityList"></div>
            </div>
        </div>
        <div class="tab-content" id="reports">
            <div class="card">
                <h3>üìä Tu Productividad</h3>
                <div class="report-controls">
                    <button class="btn-subtle active" id="report-week">Semana</button>
                    <button class="btn-subtle" id="report-month">Mes</button>
                    <button class="btn-subtle" id="report-year">A√±o</button>
                </div>
                <div class="chart-container">
                    <canvas id="dailyProgressChart"></canvas>
                </div>
                <div class="chart-container">
                    <canvas id="activityDistributionChart"></canvas>
                </div>
                <div id="reportSummary"></div>
            </div>
            <div class="card">
                <h3>üèÜ ¬°Mis Logros!</h3>
                <p class="item-details" style="margin-bottom:15px;">Completa objetivos para desbloquear premios y mantener la motivaci√≥n.</p>
                <div class="achievements-grid" id="achievementsGrid"></div>
            </div>
        </div>

    </div>
    
    <div class="notification" id="notification"></div>
    
    <script type="module">
        // --- 1. IMPORTAR FUNCIONES DE FIREBASE ---
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, GoogleAuthProvider, onAuthStateChanged, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, onSnapshot, query, orderBy, deleteDoc, serverTimestamp, getDocs, writeBatch } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";
        
        // --- 2. CONFIGURACI√ìN DE FIREBASE (TU C√ìDIGO) ---
        const firebaseConfig = {
          apiKey: "AIzaSyD0gGVvxwFxEnfbOYIhwVDExSR9HZy1YG4",
          authDomain: "miapp-e4dc6.firebaseapp.com",
          projectId: "miapp-e4dc6",
          storageBucket: "miapp-e4dc6.appspot.com",
          messagingSenderId: "815058398646",
          appId: "1:815058398646:web:15d8a49b50ac5c660de517",
          measurementId: "G-ZG1T9MZ8MD"
        };

        // --- 3. INICIALIZACI√ìN DE FIREBASE Y SERVICIOS ---
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();

        // --- ESTADO GLOBAL Y REFERENCIAS A ELEMENTOS ---
        let tasks = [];
        let activities = [];
        let inboxItems = [];
        let achievements = {};
        let currentTheme = 'light';
        let userId = null;
        let activityDistributionChart = null;
        let dailyProgressChart = null;
        let activityTimer = { interval: null, startTime: null };

        let unsubscribers = []; // Para limpiar listeners al cerrar sesi√≥n

        const ACHIEVEMENT_LIST = {
            firstTask: { title: '¬°Primer Paso!', icon: 'üìù', description: 'Completa tu primera tarea.', condition: () => tasks.some(t => t.completed) },
            tenTasks: { title: 'Decena Cumplida', icon: '‚úçÔ∏è', description: 'Completa 10 tareas.', condition: () => tasks.filter(t => t.completed).length >= 10 },
            firstHour: { title: 'Artista Enfocada', icon: 'üé®', description: 'Registra tu primera hora de trabajo.', condition: () => activities.reduce((sum, a) => sum + a.duration, 0) >= 60 },
            inboxZero: { title: 'Mente Clara', icon: 'üßò‚Äç‚ôÄÔ∏è', description: 'Vac√≠a tu bandeja de ideas.', condition: (justDeleted) => justDeleted && inboxItems.length === 0 },
            streak3: { title: 'Constancia', icon: 'üî•', description: 'Mant√©n una racha de 3 d√≠as de actividad.', condition: () => calculateFocusStreak() >= 3 },
            streak7: { title: 'Imparable', icon: 'üöÄ', description: 'Mant√©n una racha de 7 d√≠as de actividad.', condition: () => calculateFocusStreak() >= 7 },
        };
        
        // --- GESTI√ìN DE AUTENTICACI√ìN Y CARGA INICIAL ---
        onAuthStateChanged(auth, user => {
            if (user) {
                // Usuario ha iniciado sesi√≥n
                userId = user.uid;
                document.getElementById('login-container').style.display = 'none';
                document.getElementById('app-container').style.display = 'block';
                document.getElementById('user-display').textContent = `Hola, ${user.displayName.split(' ')[0]}`;
                setupRealtimeListeners();
            } else {
                // Usuario no ha iniciado sesi√≥n
                userId = null;
                document.getElementById('login-container').style.display = 'flex';
                document.getElementById('app-container').style.display = 'none';
                
                // Limpiar listeners y datos locales
                unsubscribers.forEach(unsub => unsub());
                unsubscribers = [];
                clearLocalData();
                renderAllComponents(); 
            }
        });

        // --- EVENT LISTENERS ---
        document.getElementById('loginBtn').addEventListener('click', () => signInWithPopup(auth, provider).catch(error => console.error("Error en login:", error)));
        document.getElementById('logoutBtn').addEventListener('click', () => signOut(auth));
        document.getElementById('theme-toggle').addEventListener('click', toggleTheme);
        document.querySelectorAll('.nav-tab').forEach(tab => tab.addEventListener('click', () => switchTab(tab.dataset.tab)));
        document.getElementById('addTaskBtn').addEventListener('click', addTask);
        document.getElementById('taskInput').addEventListener('keydown', e => { if (e.key === 'Enter') addTask(); });
        document.getElementById('addInboxBtn').addEventListener('click', addInboxItem);
        document.getElementById('startActivityBtn').addEventListener('click', startActivity);
        document.getElementById('stopActivityBtn').addEventListener('click', stopActivity);
        document.querySelectorAll('.report-controls button').forEach(button => {
            button.addEventListener('click', (e) => renderReport(e.target.id.split('-')[1]));
        });

        // --- L√ìGICA DE FIREBASE (TIEMPO REAL) ---
        function setupRealtimeListeners() {
            if (!userId) return;
            const userDocRef = doc(db, 'users', userId);

            // Listener para perfil de usuario (tema, logros)
            const unsubProfile = onSnapshot(userDocRef, (doc) => {
                if (doc.exists()) {
                    const data = doc.data();
                    achievements = data.achievements || {};
                    currentTheme = data.theme || 'light';
                } else {
                    setDoc(userDocRef, { achievements: {}, theme: 'light' });
                }
                applyTheme(currentTheme);
                renderAchievements();
            });

            // Listener para Tareas
            const tasksQuery = query(collection(db, 'users', userId, 'tasks'), orderBy('createdAt', 'desc'));
            const unsubTasks = onSnapshot(tasksQuery, (snapshot) => {
                tasks = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadTasks();
                checkAndUnlockAchievements();
                updateReportsIfVisible();
            });
        
            // Listener para Actividades
            const activitiesQuery = query(collection(db, 'users', userId, 'activities'), orderBy('id', 'desc'));
            const unsubActivities = onSnapshot(activitiesQuery, (snapshot) => {
                activities = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadActivities();
                updateFocusStreak();
                checkAndUnlockAchievements();
                updateReportsIfVisible();
            });

            // Listener para Bandeja de Ideas
            const inboxQuery = query(collection(db, 'users', userId, 'inboxItems'), orderBy('createdAt', 'desc'));
            const unsubInbox = onSnapshot(inboxQuery, (snapshot) => {
                inboxItems = snapshot.docs.map(d => ({ id: d.id, ...d.data() }));
                loadInboxItems();
            });

            unsubscribers = [unsubProfile, unsubTasks, unsubActivities, unsubInbox];
        }

        // --- FUNCIONES DE LA APLICACI√ìN ---

        function clearLocalData() {
            tasks = []; activities = []; inboxItems = []; achievements = {};
        }

        function renderAllComponents() {
            loadTasks(); loadActivities(); loadInboxItems(); renderAchievements(); updateFocusStreak(); updateReportsIfVisible();
        }

        function updateReportsIfVisible(){
            if (document.getElementById('reports').classList.contains('active')) {
                const activePeriod = document.querySelector('.report-controls .active')?.id.split('-')[1] || 'week';
                renderReport(activePeriod);
            }
        }

        function switchTab(tabName) {
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            const activeTab = document.querySelector(`[data-tab="${tabName}"]`);
            if (activeTab) activeTab.classList.add('active');
            const activeContent = document.getElementById(tabName);
            if(activeContent) activeContent.classList.add('active');
            if (tabName === 'reports') renderReport('week');
        }

        async function toggleTheme() {
            currentTheme = (currentTheme === 'light') ? 'dark' : 'light';
            applyTheme(currentTheme);
            if (userId) await updateDoc(doc(db, 'users', userId), { theme: currentTheme });
            if (document.getElementById('reports').classList.contains('active')) {
                renderReport(document.querySelector('.report-controls .active')?.id.split('-')[1] || 'week');
            }
        }

        function applyTheme(theme) {
            document.body.classList.toggle('dark-mode', theme === 'dark');
            document.getElementById('theme-toggle').innerHTML = theme === 'dark' 
                ? '<svg class="icon"><use href="#icon-sun"/></svg>' 
                : '<svg class="icon"><use href="#icon-moon"/></svg>';
        }

        async function addTask() {
            const input = document.getElementById('taskInput');
            if (!input.value.trim() || !userId) return;
            try {
                await addDoc(collection(db, 'users', userId, 'tasks'), {
                    text: input.value,
                    completed: false,
                    createdAt: serverTimestamp()
                });
                input.value = '';
                showNotification('Tarea agregada ‚úÖ');
            } catch (error) {
                console.error("Error adding task: ", error);
                showNotification('Error al a√±adir tarea', 3000, true);
            }
        }

        async function toggleTask(id) {
            if (!userId) return;
            const taskRef = doc(db, 'users', userId, 'tasks', id);
            const task = tasks.find(t => t.id === id);
            if (task) {
                await updateDoc(taskRef, {
                    completed: !task.completed,
                    completedAt: !task.completed ? serverTimestamp() : null
                });
            }
        }

        async function deleteTask(id) {
            if (!userId) return;
            await deleteDoc(doc(db, 'users', userId, 'tasks', id));
        }
        
        function loadTasks() {
            const pendingList = document.getElementById('taskListPending');
            const completedList = document.getElementById('taskListCompleted');
            pendingList.innerHTML = '';
            completedList.innerHTML = '';

            const pendingTasks = tasks.filter(t => !t.completed);
            const completedTasks = tasks.filter(t => t.completed);

            if (pendingTasks.length === 0) {
                pendingList.innerHTML = '<p style="text-align:center; opacity:0.7; padding: 20px 0;">¬°No tienes tareas pendientes!</p>';
            } else {
                pendingTasks.forEach(task => pendingList.appendChild(createTaskElement(task)));
            }

            const divider = document.getElementById('completed-divider');
            const completedTitle = document.getElementById('completed-title');
            if (completedTasks.length > 0) {
                divider.style.display = 'block';
                completedTitle.style.display = 'block';
                completedTasks.forEach(task => completedList.appendChild(createTaskElement(task)));
            } else {
                divider.style.display = 'none';
                completedTitle.style.display = 'none';
            }
        }

        function createTaskElement(task) {
            const item = document.createElement('div');
            item.className = `list-item ${task.completed ? 'completed' : ''}`;
            item.innerHTML = `
                <input type="checkbox" onchange="toggleTask('${task.id}')" ${task.completed ? 'checked' : ''}>
                <div class="item-text-content"><span class="item-text">${task.text}</span></div>
                <div class="item-actions">
                    <button class="btn-icon" onclick="deleteTask('${task.id}')" title="Eliminar Tarea"><svg class="icon"><use href="#icon-delete"/></svg></button>
                </div>`;
            return item;
        }
        
        // --- BANDEJA DE IDEAS ---
        async function addInboxItem() {
            const text = document.getElementById('inboxText').value.trim();
            const url = document.getElementById('inboxUrl').value.trim();
            if ((!text && !url) || !userId) return;
            
            await addDoc(collection(db, 'users', userId, 'inboxItems'), {
                text, url, createdAt: serverTimestamp()
            });
            document.getElementById('inboxText').value = '';
            document.getElementById('inboxUrl').value = '';
            showNotification('Idea guardada en la bandeja ‚ú®');
        }

        function loadInboxItems() {
            const list = document.getElementById('inboxList');
            list.innerHTML = '';
            if (inboxItems.length === 0) {
                list.innerHTML = '<p style="text-align:center; opacity:0.7; padding: 20px 0;">Tu bandeja de ideas est√° vac√≠a. ¬°Mente despejada!</p>';
                return;
            }

            inboxItems.forEach(item => {
                const el = document.createElement('div');
                el.className = 'list-item';
                const createdAtDate = item.createdAt?.toDate ? item.createdAt.toDate().toLocaleDateString() : 'Ahora';
                el.innerHTML = `
                    <div class="item-text-content">
                        <p class="inbox-text">${item.text}</p>
                        ${item.url ? `<a href="${item.url.startsWith('http') ? '' : '//'}${item.url}" target="_blank" class="inbox-link">${item.url}</a>` : ''}
                        <p class="item-details">${createdAtDate}</p>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" title="Convertir en Tarea" onclick="convertInboxToTask('${item.id}')"><svg class="icon"><use href="#icon-forward"/></svg></button>
                        <button class="btn-icon" title="Eliminar Idea" onclick="deleteInboxItem('${item.id}')"><svg class="icon"><use href="#icon-delete"/></svg></button>
                    </div>`;
                list.appendChild(el);
            });
        }
        
        async function deleteInboxItem(id) {
            if (!userId) return;
            await deleteDoc(doc(db, 'users', userId, 'inboxItems', id));
            checkAndUnlockAchievements(true);
        }

        async function convertInboxToTask(id) {
            if (!userId) return;
            const item = inboxItems.find(i => i.id === id);
            if (item) {
                let taskText = item.text;
                if (item.url) taskText += ` (ver: ${item.url})`;
                await addDoc(collection(db, 'users', userId, 'tasks'), {
                    text: taskText,
                    completed: false,
                    createdAt: serverTimestamp()
                });
                await deleteInboxItem(id);
                showNotification('Idea convertida en tarea üëç');
                switchTab('tasks');
            }
        }
        
        // --- CRONOMETRAR ACTIVIDAD ---
        function startActivity() {
            const type = document.getElementById('activityType').value;
            const description = document.getElementById('activityDescription').value.trim();
            if(!description) { showNotification('Por favor, a√±ade una descripci√≥n.'); return; }
            activityTimer.startTime = Date.now();
            document.getElementById('activityForm').style.display = 'none';
            document.getElementById('currentActivity').style.display = 'block';
            document.getElementById('currentActivityInfo').textContent = `${type}: ${description}`;
            activityTimer.interval = setInterval(updateActivityTimer, 1000);
        }

        function updateActivityTimer() {
            const elapsed = Math.floor((Date.now() - activityTimer.startTime) / 1000);
            const h = Math.floor(elapsed / 3600).toString().padStart(2, '0');
            const m = Math.floor((elapsed % 3600) / 60).toString().padStart(2, '0');
            const s = (elapsed % 60).toString().padStart(2, '0');
            document.getElementById('activityTimer').textContent = `${h}:${m}:${s}`;
        }

        async function stopActivity() {
            clearInterval(activityTimer.interval);
            if (!userId || !activityTimer.startTime) return;
            const duration = Math.max(1, Math.round((Date.now() - activityTimer.startTime) / (1000 * 60)));
            const type = document.getElementById('activityType').value;
            const description = document.getElementById('activityDescription').value.trim();
            
            await addDoc(collection(db, 'users', userId, 'activities'), {
                type, description, duration, 
                date: new Date().toISOString().split('T')[0],
                id: Date.now()
            });
            
            document.getElementById('activityForm').style.display = 'block';
            document.getElementById('currentActivity').style.display = 'none';
            document.getElementById('activityDescription').value = '';
            document.getElementById('activityTimer').textContent = '00:00:00';
            activityTimer = { interval: null, startTime: null };
            showNotification(`Actividad de ${duration} min registrada üëç`);
        }

        function loadActivities() {
            const list = document.getElementById('activityList');
            list.innerHTML = '';
            const today = new Date().toISOString().split('T')[0];
            const todayActivities = activities.filter(a => a.date === today);

            if(todayActivities.length === 0) {
                list.innerHTML = '<p style="text-align:center; opacity:0.7; padding: 20px 0;">No has registrado actividades hoy.</p>';
                return;
            }

            todayActivities.forEach(act => {
                const item = document.createElement('div');
                item.className = 'list-item';
                const activityTime = act.id ? new Date(act.id).toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'}) : '';
                item.innerHTML = `
                    <div class="item-text-content">
                        <span class="item-text">${act.type}: ${act.description}</span>
                        <span class="item-details">${act.duration} minutos - ${activityTime}</span>
                    </div>
                    <div class="item-actions">
                        <button class="btn-icon" title="A√±adir a Google Calendar" onclick="createGoogleCalendarEvent('${act.id}')">
                            <svg class="icon" style="width: 20px; height: 20px;"><use href="#icon-google"/></svg>
                        </button>
                    </div>`;
                list.prepend(item);
            });
        }

        function createGoogleCalendarEvent(activityIdStr) {
            const activityId = parseInt(activityIdStr, 10);
            const activity = activities.find(a => a.id === activityId);
            if (!activity) return;

            const startTime = new Date(activity.id);
            const endTime = new Date(startTime.getTime() + activity.duration * 60000);
            function formatGCDate(date) { return date.toISOString().replace(/[-:]|\.\d{3}/g, ''); }

            const url = new URL('https://www.google.com/calendar/render');
            url.searchParams.append('action', 'TEMPLATE');
            url.searchParams.append('text', `${activity.type}: ${activity.description}`);
            url.searchParams.append('dates', `${formatGCDate(startTime)}/${formatGCDate(endTime)}`);
            url.searchParams.append('details', `Actividad registrada en Crea Infantil.\nDuraci√≥n: ${activity.duration} minutos.`);
            window.open(url, '_blank');
        }

        // --- REPORTES Y GR√ÅFICOS ---
        function renderReport(period) {
            document.querySelectorAll('.report-controls button').forEach(b => b.classList.remove('active'));
            document.getElementById(`report-${period}`).classList.add('active');

            const { periodActivities, periodTasksCompleted, labels, timeUnit, formatLabel } = getPeriodData(period);
            const textColor = getComputedStyle(document.body).getPropertyValue('--text-color');
            const gridColor = getComputedStyle(document.body).getPropertyValue('--border-color');

            // Gr√°fico 1: Distribuci√≥n de tiempo
            const activityDistributionData = periodActivities.reduce((acc, curr) => {
                acc[curr.type] = (acc[curr.type] || 0) + curr.duration;
                return acc;
            }, {});
            
            const doughnutCtx = document.getElementById('activityDistributionChart').getContext('2d');
            if (activityDistributionChart) activityDistributionChart.destroy();
            activityDistributionChart = new Chart(doughnutCtx, {
                type: 'doughnut',
                data: {
                    labels: Object.keys(activityDistributionData),
                    datasets: [{
                        data: Object.values(activityDistributionData),
                        backgroundColor: ['#1D9A8D', '#f4a261', '#e76f51', '#2a9d8f', '#e9c46a', '#264653'],
                        borderColor: getComputedStyle(document.body).getPropertyValue('--card-bg'),
                        borderWidth: 4
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        legend: { display: periodActivities.length > 0, position: 'right', labels: { color: textColor, padding: 15 } },
                        title: { display: true, text: 'Distribuci√≥n de Tiempo por Actividad (min)', color: textColor, font: {size: 14} },
                        tooltip: { callbacks: { label: (c) => `${c.label}: ${c.parsed} min` } }
                    }
                }
            });
            
            // Gr√°fico 2: Progreso en el tiempo
            const progressData = labels.map(labelDate => {
                const labelKey = formatLabel(labelDate);
                const time = periodActivities
                    .filter(a => formatLabel(new Date(a.date + "T00:00:00")) === labelKey)
                    .reduce((sum, a) => sum + a.duration, 0);
                const taskCount = periodTasksCompleted
                    .filter(t => t.completedAt && formatLabel(t.completedAt.toDate()) === labelKey)
                    .length;
                return { time, taskCount };
            });
            
            const barCtx = document.getElementById('dailyProgressChart').getContext('2d');
            if (dailyProgressChart) dailyProgressChart.destroy();
            dailyProgressChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: labels.map(d => formatLabel(d)),
                    datasets: [
                        { label: 'Minutos de Foco', data: progressData.map(d => d.time), backgroundColor: 'rgba(29, 154, 141, 0.6)', yAxisID: 'yTime' },
                        { label: 'Tareas Completadas', data: progressData.map(d => d.taskCount), backgroundColor: 'rgba(244, 162, 97, 0.6)', yAxisID: 'yTasks' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        yTime: { beginAtZero: true, position: 'left', title: { display: true, text: 'Minutos', color: textColor }, ticks: { color: textColor }, grid: { color: gridColor } },
                        yTasks: { beginAtZero: true, position: 'right', title: { display: true, text: 'Tareas', color: textColor }, ticks: { color: textColor, stepSize: 1 }, grid: { drawOnChartArea: false } }
                    },
                    plugins: {
                        title: { display: true, text: `Progreso ${timeUnit}`, color: textColor, font: {size: 14} },
                        legend: { labels: { color: textColor } }
                    }
                }
            });
            
            const totalMinutes = periodActivities.reduce((sum, a) => sum + a.duration, 0);
            document.getElementById('reportSummary').innerHTML = `<hr class="divider"><p>En este per√≠odo has dedicado <strong>${(totalMinutes / 60).toFixed(1)} horas</strong> a crear y has completado <strong>${periodTasksCompleted.length} tareas</strong>.</p>`;
        }

        function getPeriodData(period) {
            const now = new Date();
            now.setHours(23, 59, 59, 999);
            let startDate = new Date();
            startDate.setHours(0, 0, 0, 0);
            let labels = [], timeUnit = '', formatLabel;

            switch(period) {
                case 'week':
                    startDate.setDate(now.getDate() - 6);
                    for(let i=0; i<=6; i++){ const d = new Date(startDate); d.setDate(d.getDate() + i); labels.push(d); }
                    timeUnit = 'Semanal';
                    formatLabel = (d) => d.toLocaleDateString('es-ES', { weekday: 'short' });
                    break;
                case 'month':
                    startDate.setDate(now.getDate() - 29);
                    for(let i=0; i<=29; i++){ const d = new Date(startDate); d.setDate(d.getDate() + i); labels.push(d); }
                    timeUnit = 'Mensual';
                    formatLabel = (d) => d.toLocaleDateString('es-ES', { day: 'numeric', month: 'short' });
                    break;
                case 'year':
                    labels = [];
                    const currentYear = now.getFullYear();
                    for(let i = 0; i < 12; i++) {
                        labels.push(new Date(currentYear, i, 1));
                    }
                    startDate = new Date(currentYear, 0, 1);
                    timeUnit = 'Anual';
                    formatLabel = (d) => d.toLocaleDateString('es-ES', { month: 'short' });
                    break;
            }
            
            const periodActivities = activities.filter(a => a.date && new Date(a.date) >= startDate && new Date(a.date) <= now);
            const periodTasksCompleted = tasks.filter(t => t.completed && t.completedAt && t.completedAt.toDate() >= startDate && t.completedAt.toDate() <= now);

            return { periodActivities, periodTasksCompleted, labels, timeUnit, formatLabel };
        }
        
        // --- MOTIVACI√ìN Y LOGROS ---
        async function checkAndUnlockAchievements(justDeletedInboxItem = false) {
            if (!userId) return;
            let newAchievementUnlocked = false;
            const docRef = doc(db, 'users', userId);
            const currentAchievements = (await getDoc(docRef)).data().achievements || {};
            const updates = {};
            
            for (const key in ACHIEVEMENT_LIST) {
                const ach = ACHIEVEMENT_LIST[key];
                if (!currentAchievements[key] && ach.condition(justDeletedInboxItem)) {
                    updates[`achievements.${key}`] = true;
                    newAchievementUnlocked = true;
                    showNotification(`üèÜ ¬°Logro Desbloqueado: ${ach.title}!`, 4000);
                }
            }
            if (newAchievementUnlocked) {
                await updateDoc(docRef, updates);
            }
        }

        function renderAchievements() {
            const grid = document.getElementById('achievementsGrid');
            grid.innerHTML = '';
            for (const key in ACHIEVEMENT_LIST) {
                const ach = ACHIEVEMENT_LIST[key];
                const unlocked = achievements[key];
                const card = document.createElement('div');
                card.className = `achievement-card ${unlocked ? 'unlocked' : 'locked'}`;
                card.title = unlocked ? ach.description : `Bloqueado: ${ach.description}`;
                card.innerHTML = `<span class="icon" style="font-size: 3em;">${ach.icon}</span><p>${ach.title}</p>`;
                grid.appendChild(card);
            }
        }

        function calculateFocusStreak() {
            const activityDates = [...new Set(activities.map(a => a.date.split('T')[0]))].sort((a,b) => new Date(b) - new Date(a));
            if (activityDates.length === 0) return 0;
            
            let streak = 0;
            let checkDate = new Date();
            checkDate.setHours(0,0,0,0);
            
            let lastActivityDate = new Date(activityDates[0]);
            lastActivityDate.setHours(0,0,0,0);
            
            const diffToday = (checkDate.getTime() - lastActivityDate.getTime()) / (1000 * 3600 * 24);

            if (diffToday > 1) return 0;
            
            streak = (diffToday <= 1) ? 1 : 0;
            if (streak === 0) return 0;

            for (let i = 0; i < activityDates.length - 1; i++) {
                const current = new Date(activityDates[i]);
                const previous = new Date(activityDates[i+1]);
                const diffDays = Math.round((current.getTime() - previous.getTime()) / (1000 * 3600 * 24));
                if (diffDays === 1) {
                    streak++;
                } else {
                    break;
                }
            }
            return streak;
        }

        function updateFocusStreak() {
            const streak = calculateFocusStreak();
            document.getElementById('focusStreak').innerHTML = `üî• Racha de ${streak} d√≠a${streak === 1 ? '' : 's'}`;
        }
        
        // --- UTILIDADES ---
        function showNotification(message, duration = 3000) {
            const el = document.getElementById('notification');
            el.textContent = message;
            el.classList.add('show');
            setTimeout(() => el.classList.remove('show'), duration);
        }
    </script>
</body>
</html>
