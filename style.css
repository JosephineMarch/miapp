onAuthStateChanged(auth, user => {
    const loginContainer = document.getElementById('login-container');
    const appContainer = document.getElementById('app-container');
    const bottomNav = document.querySelector('.bottom-nav');

    if (user) {
        if (userId !== user.uid) { 
            userId = user.uid;
            
            // Poblar el header
            document.getElementById('user-display-name').textContent = user.displayName.split(' ')[0];
            document.getElementById('user-avatar').src = user.photoURL || 'https://i.pravatar.cc/40';

            // Mostrar la app
            loginContainer.classList.remove('visible');
            appContainer.classList.add('visible');
            bottomNav.classList.add('visible');
            
            setupRealtimeListeners();
        }
    } else {
        userId = null;
        
        // Mostrar el login
        loginContainer.classList.add('visible');
        appContainer.classList.remove('visible');
        bottomNav.classList.remove('visible');
        
        unsubscribers.forEach(unsub => unsub());
        unsubscribers = [];
        clearLocalData();
    }
});
